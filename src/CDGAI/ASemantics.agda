module CDGAI.ASemantics where

open import Prelude
open import POSet
open import CDGAI.ASyntax

âŸ¦_âŸ§áµƒÂ¹ : unary â†’ â„¤ â†’ â„¤
âŸ¦ [+] âŸ§áµƒÂ¹ = sucá¶»
âŸ¦ [-] âŸ§áµƒÂ¹ = predá¶»

data _âˆˆâŸ¦_âŸ§áµƒÂ²[_,_] : â„¤ â†’ binary â†’ â„¤ â†’ â„¤ â†’ Set where
  [+] : âˆ€ {nâ‚ nâ‚‚} â†’ (nâ‚ + nâ‚‚) âˆˆâŸ¦ [+] âŸ§áµƒÂ²[ nâ‚ , nâ‚‚ ]
  [-] : âˆ€ {nâ‚ nâ‚‚} â†’ (nâ‚ - nâ‚‚) âˆˆâŸ¦ [-] âŸ§áµƒÂ²[ nâ‚ , nâ‚‚ ]
  [Ã—] : âˆ€ {nâ‚ nâ‚‚} â†’ (nâ‚ â¨¯ nâ‚‚) âˆˆâŸ¦ [Ã—] âŸ§áµƒÂ²[ nâ‚ , nâ‚‚ ]
  [/] : âˆ€ {nâ‚ nâ‚‚} (nâ‚‚â‰ 0 : nâ‚‚ â‰¢ Zero) â†’ (nâ‚ / nâ‚‚ â€– nâ‚‚â‰ 0) âˆˆâŸ¦ [/] âŸ§áµƒÂ²[ nâ‚ , nâ‚‚ ]
  [%] : âˆ€ {nâ‚ nâ‚‚} (nâ‚‚â‰ 0 : nâ‚‚ â‰¢ Zero) â†’ (nâ‚ % nâ‚‚ â€– nâ‚‚â‰ 0) âˆˆâŸ¦ [%] âŸ§áµƒÂ²[ nâ‚ , nâ‚‚ ]

data env : context â†’ Set where
  [] : env zero
  _âˆ·_ : âˆ€ {Î“} â†’ â„¤ â†’ env Î“ â†’ env (Suc Î“)

instance
  env-PreOrder : âˆ€ {Î“} â†’ PreOrder zeroË¡ (env Î“)
  env-PreOrder = â‰¡-PreOrder

_[_] : âˆ€ {Î“} â†’ env Î“ â†’ var Î“ â†’ â„¤
(n âˆ· Ï) [ Zero ] = n
(n âˆ· Ï) [ Suc x ] = Ï [ x ]

_[_â†¦_] : âˆ€ {Î“} â†’ env Î“ â†’ var Î“ â†’ â„¤ â†’ env Î“
(i âˆ· Ï) [ Zero â†¦ i' ] = i' âˆ· Ï
(i âˆ· Ï) [ Suc x â†¦ i' ] = i âˆ· Ï [ x â†¦ i' ]

data _âŠ¢_â‡“áµƒ_ {Î“} : env Î“ â†’ aexp Î“ â†’ â„¤ â†’ Set where
  Num : âˆ€ {Ï n} â†’ Ï âŠ¢ Num n â‡“áµƒ n
  Var : âˆ€ {Ï x} â†’ Ï âŠ¢ Var x â‡“áµƒ Ï [ x ]
  âŠ¤â„¤ : âˆ€ {Ï n} â†’ Ï âŠ¢ âŠ¤â„¤ â‡“áµƒ n
  Unary : âˆ€ {Ï o e n} â†’ Ï âŠ¢ e â‡“áµƒ n â†’ Ï âŠ¢ Unary[ o ] e â‡“áµƒ âŸ¦ o âŸ§áµƒÂ¹ n
  Binary : âˆ€ {Ï o eâ‚ eâ‚‚ nâ‚ nâ‚‚ nâ‚ƒ} â†’ Ï âŠ¢ eâ‚ â‡“áµƒ nâ‚ â†’ Ï âŠ¢ eâ‚‚ â‡“áµƒ nâ‚‚ â†’ nâ‚ƒ âˆˆâŸ¦ o âŸ§áµƒÂ²[ nâ‚ , nâ‚‚ ] â†’ Ï âŠ¢ Binary[ o ] eâ‚ eâ‚‚ â‡“áµƒ nâ‚ƒ

-- Ordered Universe --

âŸ¦_âŸ§áµƒÂ¹âº : unary â†’ âŸª â‡§ â„¤ â‡’ â‡§ â„¤ âŸ«
âŸ¦ o âŸ§áµƒÂ¹âº = witness-x (curryâ¸¢Î»â†‘â¸£ idâ¸¢Î»â†‘â¸£) $ mk[witness] âŸ¦ o âŸ§áµƒÂ¹ res-x

âŸ¦_âŸ§áµƒÂ²âº : binary â†’ âŸª â‡§ â„¤ â‡’ â‡§ â„¤ â‡’ ğ’« (â‡§ â„¤) âŸ« 
âŸ¦ o âŸ§áµƒÂ²âº = witness-x (curryâ¸¢Î»â†‘â¸£ $ curryâ¸¢Î»â†‘â¸£ idâ¸¢Ï‰â†‘â¸£) $ mk[witness] (Î» x y z â†’ z âˆˆâŸ¦ o âŸ§áµƒÂ²[ x , y ]) ppr
  where
    abstract
      ppr : proper (_âŠ´_ â‡‰ _âŠ´_ â‡‰ _âŠµ_ â‡‰ [â†’]) (Î» x y z â†’ z âˆˆâŸ¦ o âŸ§áµƒÂ²[ x , y ])
      ppr â†¯ â†¯ â†¯ = id

lookup[_]âº : âˆ€ {Î“} â†’ var Î“ â†’ âŸª â‡§ (env Î“) â‡’ â‡§ â„¤ âŸ«
lookup[ x ]âº = witness-x (curryâ¸¢Î»â†‘â¸£ idâ¸¢Î»â†‘â¸£) $ mk[witness] (Î» Ï â†’ Ï [ x ]) res-x

âŸ¦_âŸ§áµƒâº : âˆ€ {Î“} â†’ aexp Î“ â†’ âŸª â‡§ (env Î“) â‡’ ğ’« (â‡§ â„¤) âŸ«
âŸ¦ e âŸ§áµƒâº = witness-x (curryâ¸¢Î»â†‘â¸£ idâ¸¢Ï‰â†‘â¸£) $ mk[witness] (Î» Ï n â†’ Ï âŠ¢ e â‡“áµƒ n) ppr
    where
      ppr : proper (_âŠ´_ â‡‰ flip _âŠ´_ â‡‰ [â†’]) (Î» Ï n â†’ Ï âŠ¢ e â‡“áµƒ n)
      ppr â†¯ â†¯ = id

ğ’âŸ¦NumâŸ§â¸¢âŠ‘â¸£ : âˆ€ {Î“} {n : â„¤} {R : âŸª ğ’« (â‡§ (env Î“)) âŸ«} â†’ âŸ¦ Num n âŸ§áµƒâº * â‹… R âŠ‘ return â‹… â†‘ n
ğ’âŸ¦NumâŸ§â¸¢âŠ‘â¸£ {Î“} {n} {R} = ext[ğ’«]â¸¢âŠ‘â¸£ H
  where
    H : âˆ€ {n'} â†’ n' â‹¿ âŸ¦ Num n âŸ§áµƒâº * â‹… R â†’ n' âŠ‘ â†‘ n
    H {â†‘âŸ¨ .n âŸ©} (âˆƒğ’« x ,, xâˆˆR ,, Num) = xRx

ğ’âŸ¦NumâŸ§â¸¢âŠ’â¸£ :
  âˆ€ {Î“} {n : â„¤} {R : âŸª ğ’« (â‡§ (env Î“)) âŸ«}
  â†’ âˆƒ Ï ğ‘ ğ‘¡ Ï â‹¿ R
  â†’ return â‹… â†‘ n âŠ‘ âŸ¦ Num n âŸ§áµƒâº * â‹… R
ğ’âŸ¦NumâŸ§â¸¢âŠ’â¸£ {Î“} {n} {R} (âˆƒ Ï ,, Ïâ‹¿R) = Ï€â‚‚ returnâ†”â‹¿ $ âˆƒğ’« Ï ,, Ïâ‹¿R ,, Num

ğ’âŸ¦VarâŸ§ : âˆ€ {Î“} {x : var Î“} {Ï : âŸª â‡§ (env Î“) âŸ«} â†’ âŸ¦ Var x âŸ§áµƒâº â‹… Ï â‰ˆ return â‹… (lookup[ x ]âº â‹… Ï)
ğ’âŸ¦VarâŸ§ {Î“} {x} {â†‘âŸ¨ Ï âŸ©} = ext[ğ’«]â¸¢â‰ˆâ¸£ $ LHS , RHS
  where
    LHS : âˆ€ {n} â†’ n â‹¿ âŸ¦ Var x âŸ§áµƒâº â‹… â†‘ Ï â†’ n â‹¿ return â‹… (lookup[ x ]âº â‹… â†‘ Ï)
    LHS {â†‘âŸ¨ .(Ï [ x ]) âŸ©} Var = xRx
    RHS : âˆ€ {n} â†’ n â‹¿ return â‹… (lookup[ x ]âº â‹… â†‘ Ï) â†’ n â‹¿ âŸ¦ Var x âŸ§áµƒâº â‹… â†‘ Ï
    RHS â†‘âŸ¨ â†¯ âŸ© = Var

ğ’âŸ¦VarâŸ§â¸¢âŠ™â¸£ : âˆ€ {Î“} {x : var Î“} â†’ âŸ¦ Var x âŸ§áµƒâº â‰ˆ pure â‹… lookup[ x ]âº
ğ’âŸ¦VarâŸ§â¸¢âŠ™â¸£ = ext[â‡’]â¸¢â‰ˆâ¸£ $ Î» {Ï} â†’ ğ’âŸ¦VarâŸ§ {Ï = Ï}

ğ’âŸ¦âŠ¤â„¤âŸ§â¸¢âŠ‘â¸£ : âˆ€ {Î“} {R : âŸª ğ’« (â‡§ (env Î“)) âŸ«} â†’ âŸ¦ âŠ¤â„¤ âŸ§áµƒâº * â‹… R âŠ‘ allâº (â‡§ â„¤)
ğ’âŸ¦âŠ¤â„¤âŸ§â¸¢âŠ‘â¸£ {Î“} {R} = ext[ğ’«]â¸¢âŠ‘â¸£ $ Î» {n} â†’ const $ all-in {x = n}

ğ’âŸ¦UnaryâŸ§ : âˆ€ {Î“} {o : unary} {e : aexp Î“} {Ï : âŸª â‡§ (env Î“) âŸ«} â†’ âŸ¦ Unary[ o ] e âŸ§áµƒâº â‹… Ï â‰ˆ (pure â‹… âŸ¦ o âŸ§áµƒÂ¹âº) * â‹… (âŸ¦ e âŸ§áµƒâº â‹… Ï)
ğ’âŸ¦UnaryâŸ§ {Î“} {o} {e} {Ï} = ext[ğ’«]â¸¢â‰ˆâ¸£ $ LHS , RHS
  where
    LHS : âˆ€ {n} â†’ n â‹¿ âŸ¦ Unary[ o ] e âŸ§áµƒâº â‹… Ï â†’ n â‹¿ (pure â‹… âŸ¦ o âŸ§áµƒÂ¹âº) * â‹… (âŸ¦ e âŸ§áµƒâº â‹… Ï)
    LHS {â†‘âŸ¨ .(âŸ¦ o âŸ§áµƒÂ¹ n) âŸ©} (Unary {n = n} ÏâŠ¢eâ‡“n) = âˆƒğ’« â†‘ n ,, ÏâŠ¢eâ‡“n ,, xRx
    RHS : âˆ€ {n} â†’ n â‹¿ (pure â‹… âŸ¦ o âŸ§áµƒÂ¹âº) * â‹… (âŸ¦ e âŸ§áµƒâº â‹… Ï) â†’ n â‹¿ âŸ¦ Unary[ o ] e âŸ§áµƒâº â‹… Ï
    RHS (âˆƒğ’« n' ,, ÏâŠ¢eâ‡“n' ,, â†‘âŸ¨ â†¯ âŸ©) = Unary ÏâŠ¢eâ‡“n'

ğ’âŸ¦UnaryâŸ§â¸¢âŸâ¸£ : âˆ€ {Î“} {o : unary} {e : aexp Î“} â†’ âŸ¦ Unary[ o ] e âŸ§áµƒâº â‰ˆ pure â‹… âŸ¦ o âŸ§áµƒÂ¹âº âŸ âŸ¦ e âŸ§áµƒâº
ğ’âŸ¦UnaryâŸ§â¸¢âŸâ¸£ = ext[â‡’]â¸¢â‰ˆâ¸£ $ Î» {Ï} â†’ ğ’âŸ¦UnaryâŸ§ {Ï = Ï}

ğ’âŸ¦BinaryâŸ§â¸¢*â¸£â¸¢â‹¿â¸£ :
  âˆ€ {Î“} {o : binary} {eâ‚ eâ‚‚ : aexp Î“} {R : âŸª ğ’« (â‡§ (env Î“)) âŸ«} {n : âŸª â‡§ â„¤ âŸ«}
  â†’ n â‹¿ âŸ¦ Binary[ o ] eâ‚ eâ‚‚ âŸ§áµƒâº * â‹… R â†’ n â‹¿ (uncurryâº â‹… âŸ¦ o âŸ§áµƒÂ²âº) * â‹… (Î³â¸¢IAâ¸£ â‹… (âŸ¦ eâ‚ âŸ§áµƒâº * â‹… R ,âº âŸ¦ eâ‚‚ âŸ§áµƒâº * â‹… R))
ğ’âŸ¦BinaryâŸ§â¸¢*â¸£â¸¢â‹¿â¸£ {n = n} (âˆƒğ’« Ï ,, ÏâˆˆR ,, Binary {nâ‚ = nâ‚} {nâ‚‚} {.(â†“ n)} ÏâŠ¢eâ‚â‡“nâ‚ ÏâŠ¢eâ‡“nâ‚‚ nâ‚ƒâˆˆâŸ¦oâŸ§áµ‡[nâ‚,nâ‚‚]) =
  âˆƒğ’« â†‘âŸ¨ â†‘ nâ‚ , â†‘ nâ‚‚ âŸ© ,, (âˆƒğ’« Ï ,, ÏâˆˆR ,, ÏâŠ¢eâ‚â‡“nâ‚) ,  (âˆƒğ’« Ï ,, ÏâˆˆR ,, ÏâŠ¢eâ‡“nâ‚‚) ,, nâ‚ƒâˆˆâŸ¦oâŸ§áµ‡[nâ‚,nâ‚‚]

ğ’âŸ¦BinaryâŸ§â¸¢*â¸£â¸¢âŠ‘â¸£ :
  âˆ€ {Î“} {o : binary} {eâ‚ eâ‚‚ : aexp Î“} {R : âŸª ğ’« (â‡§ (env Î“)) âŸ«}
  â†’ âŸ¦ Binary[ o ] eâ‚ eâ‚‚ âŸ§áµƒâº * â‹… R âŠ‘ (uncurryâº â‹… âŸ¦ o âŸ§áµƒÂ²âº) * â‹… (Î³â¸¢IAâ¸£ â‹… (âŸ¦ eâ‚ âŸ§áµƒâº * â‹… R ,âº âŸ¦ eâ‚‚ âŸ§áµƒâº * â‹… R))
ğ’âŸ¦BinaryâŸ§â¸¢*â¸£â¸¢âŠ‘â¸£ = ext[ğ’«]â¸¢âŠ‘â¸£ $ Î» {n} â†’ ğ’âŸ¦BinaryâŸ§â¸¢*â¸£â¸¢â‹¿â¸£ {n = n}
