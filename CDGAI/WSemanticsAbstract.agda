module CDGAI.WSemanticsAbstract where

open import Prelude
open import Poset
open import CDGAI.ZAbstraction
open import CDGAI.BoolAbstraction
open import CDGAI.EnvAbstraction
open import CDGAI.ASyntax
open import CDGAI.BSemantics
open import CDGAI.ASemantics
open import CDGAI.ASemanticsAbstract
open import CDGAI.BSemanticsAbstract
open import CDGAI.WSyntax
open import CDGAI.WSemantics

module _ {â„“} {A Bâ‚ Bâ‚‚ : Poset â„“} (â‡„Bâ‡„ : Bâ‚ â‡„á¶œ Bâ‚‚) where
  L1 : âˆ€ {x : âŸª A âŸ«} {yâ™¯ : âŸª Bâ‚‚ âŸ«} â†’ (pure â‹… ([,] â‹… x)) *â™® â‹… (Î³á¶œ[ â‡„Bâ‡„ ] â‹… yâ™¯) â‰ˆâ™® Î³á¶œ[ idâ¸¢â‡„á¶œâ¸£ âˆ§â¸¢â‡„á¶œâ¸£ â‡„Bâ‡„ ] â‹… âŸ¨ x ,â™® yâ™¯ âŸ©
  L1 {x} {yâ™¯} = ext[â„˜]â¸¢â‰ˆâ¸£ $ Î» {Ï€} â†’ âŸ¨ LHS {Ï€} , RHS {Ï€} âŸ©
    where
      LHS : âˆ€ {Ï€} â†’ Ï€ â‹¿ (pure â‹… ([,] â‹… x)) *â™® â‹… (Î³á¶œ[ â‡„Bâ‡„ ] â‹… yâ™¯) â†’ Ï€ â‹¿ Î³á¶œ[ idâ¸¢â‡„á¶œâ¸£ âˆ§â¸¢â‡„á¶œâ¸£ â‡„Bâ‡„ ] â‹… âŸ¨ x ,â™® yâ™¯ âŸ©
      LHS {â™®âŸ¨ âŸ¨ xâ€² , yâ€² âŸ© âŸ©} (âˆƒâ„˜ y ,, â‹¿Î³ ,, â™®âŸ¨ âŸ¨ âŠ‘â‚“ , âŠ‘Ê¸ âŸ© âŸ©) = âŸ¨ âŠ‘â‚“ , res[x][â„˜]â¸¢âŠ‘â¸£ {X = Î³á¶œ[ â‡„Bâ‡„ ] â‹… yâ™¯} âŠ‘Ê¸ â‹¿Î³ âŸ©
      RHS : âˆ€ {Ï€} â†’ Ï€ â‹¿ Î³á¶œ[ idâ¸¢â‡„á¶œâ¸£ âˆ§â¸¢â‡„á¶œâ¸£ â‡„Bâ‡„ ] â‹… âŸ¨ x ,â™® yâ™¯ âŸ© â†’ Ï€ â‹¿ (pure â‹… ([,] â‹… x)) *â™® â‹… (Î³á¶œ[ â‡„Bâ‡„ ] â‹… yâ™¯)
      RHS {â™®âŸ¨ âŸ¨ xâ€² , yâ€² âŸ© âŸ©} âŸ¨ âŠ‘â‚“ , â‹¿Î³ âŸ© = âˆƒâ„˜ yâ€² ,, â‹¿Î³ ,, â™®âŸ¨ âŸ¨ âŠ‘â‚“ , xRx âŸ© âŸ©

module _ {â„“} {A B C : Poset â„“} where
  L2 : âˆ€ {g : âŸª A â†— B â†— â„˜ C âŸ«} {f : âŸª A â†— â„˜ B âŸ«} {X : âŸª â„˜ A âŸ«}
    â†’  (applyâ™® âˆ˜â™® applyâ¸¢âˆ§â™®â¸£ â‹… âŸ¨ [*] âˆ˜â™® g ,â™® f âŸ© âˆ˜â™® splitâ™®) *â™® â‹… X
    âŠ‘â™® (uncurryâ™® â‹… g) *â™® â‹… (Î³â¸¢IAâ¸£ â‹… âŸ¨ X  ,â™® f *â™® â‹… X âŸ©)
  L2 {g} {f} {X} = ext[â„˜]â¸¢âŠ‘â¸£ P
    where
      P : âˆ€ {c : âŸª C âŸ«} â†’ c â‹¿ (applyâ™® âˆ˜â™® applyâ¸¢âˆ§â™®â¸£ â‹… âŸ¨ [*] âˆ˜â™® g ,â™® f âŸ© âˆ˜â™® splitâ™®) *â™® â‹… X â†’ c â‹¿ (uncurryâ™® â‹… g) *â™® â‹… (Î³â¸¢IAâ¸£ â‹… âŸ¨ X  ,â™® f *â™® â‹… X âŸ©)
      P (âˆƒâ„˜ x ,, âˆˆâ‚“ ,, âˆƒâ„˜ y ,, âˆˆÊ¸ ,, âˆˆá¶œ) = âˆƒâ„˜ â™®âŸ¨ âŸ¨ x , y âŸ© âŸ© ,, âŸ¨ âˆˆâ‚“ , (âˆƒâ„˜ x ,, âˆˆâ‚“ ,, âˆˆÊ¸) âŸ© ,, âˆˆá¶œ

module _ {â„“} {Aâ‚ Aâ‚‚ Bâ‚ Bâ‚‚ : Poset â„“} (â‡„Aâ‡„ : Aâ‚ â‡„á¶œ Aâ‚‚) (â‡„Bâ‡„ : Bâ‚ â‡„á¶œ Bâ‚‚) where
  L3 : âˆ€ {xâ™¯ yâ™¯} â†’ Î³â¸¢IAâ¸£ â‹… âŸ¨ Î³á¶œ[ â‡„Aâ‡„ ] â‹… xâ™¯ ,â™® Î³á¶œ[ â‡„Bâ‡„ ] â‹… yâ™¯ âŸ© â‰ˆâ™® Î³á¶œ[ â‡„Aâ‡„ âˆ§â¸¢â‡„á¶œâ¸£ â‡„Bâ‡„ ] â‹… âŸ¨ xâ™¯ ,â™® yâ™¯ âŸ©
  L3 {xâ™¯} {yâ™¯} = ext[â„˜]â¸¢â‰ˆâ¸£ $ Î» {xy} â†’ âŸ¨ LHS {xy} , RHS {xy} âŸ©
    where
      LHS : âˆ€ {xy} â†’ xy â‹¿ Î³â¸¢IAâ¸£ â‹… âŸ¨ Î³á¶œ[ â‡„Aâ‡„ ] â‹… xâ™¯ ,â™® Î³á¶œ[ â‡„Bâ‡„ ] â‹… yâ™¯ âŸ© â†’ xy â‹¿ Î³á¶œ[ â‡„Aâ‡„ âˆ§â¸¢â‡„á¶œâ¸£ â‡„Bâ‡„ ] â‹… âŸ¨ xâ™¯ ,â™® yâ™¯ âŸ©
      LHS {â™®âŸ¨ âŸ¨ x , y âŸ© âŸ©} âŸ¨ â‹¿â‚“ , â‹¿Ê¸ âŸ© = âŸ¨ â‹¿â‚“ , â‹¿Ê¸ âŸ©
      RHS : âˆ€ {xy} â†’ xy â‹¿ Î³á¶œ[ â‡„Aâ‡„ âˆ§â¸¢â‡„á¶œâ¸£ â‡„Bâ‡„ ] â‹… âŸ¨ xâ™¯ ,â™® yâ™¯ âŸ© â†’ xy â‹¿ Î³â¸¢IAâ¸£ â‹… âŸ¨ Î³á¶œ[ â‡„Aâ‡„ ] â‹… xâ™¯ ,â™® Î³á¶œ[ â‡„Bâ‡„ ] â‹… yâ™¯ âŸ©
      RHS {â™®âŸ¨ âŸ¨ x , y âŸ© âŸ©} âŸ¨ â‹¿â‚“ , â‹¿Ê¸ âŸ© = âŸ¨ â‹¿â‚“ , â‹¿Ê¸ âŸ©

module _ {â„“} {A B C : Poset â„“} where
  L4 : âˆ€ {f : âŸª A â†— B â†— C âŸ«} â†’ uncurryâ™® â‹… (pure âˆ˜â™® f) â‰ˆâ™® pure â‹… (uncurryâ™® â‹… f)
  L4 {f} = ext[â†—]â¸¢â‰ˆâ¸£ $ Î» {xy} â†’ ext[â„˜]â¸¢â‰ˆâ¸£ $ Î» {z} â†’ âŸ¨ LHS {xy} {z} , RHS {xy} {z} âŸ©
    where
      LHS : âˆ€ {xy z} â†’ z â‹¿ uncurryâ™® â‹… (pure âˆ˜â™® f) â‹… xy â†’ z â‹¿ pure â‹… (uncurryâ™® â‹… f) â‹… xy
      LHS {â™®âŸ¨ âŸ¨ x , y âŸ© âŸ©} â‹¿â‚€ = â‹¿â‚€
      RHS : âˆ€ {xy z} â†’ z â‹¿ pure â‹… (uncurryâ™® â‹… f) â‹… xy â†’ z â‹¿ uncurryâ™® â‹… (pure âˆ˜â™® f) â‹… xy
      RHS {â™®âŸ¨ âŸ¨ x , y âŸ© âŸ©} â‹¿â‚€ = â‹¿â‚€

module _ {â„“} {A Bâ‚ Bâ‚‚ : Poset â„“} (â‡„Bâ‡„ : Bâ‚ â‡„á¶œ Bâ‚‚) where
  Î·[,] : âˆ€ (x : âŸª A âŸ«) (y : âŸª Bâ‚ âŸ«) â†’ Î·á¶œ[ idâ¸¢â‡„á¶œâ¸£ {A = A} âˆ§â¸¢â‡„á¶œâ¸£ â‡„Bâ‡„ ] â‹… âŸ¨ x ,â™® y âŸ© âŠ‘â™® âŸ¨ x ,â™® Î·á¶œ[ â‡„Bâ‡„ ] â‹… y âŸ©
  Î·[,] x y = xRx

  Î±[,] : âˆ€ (x : âŸª A âŸ«) â†’ Î±[ â‡„Bâ‡„ â†—â¸¢â‡„á¶œâ¸£ (idâ¸¢â‡„á¶œâ¸£ âˆ§â¸¢â‡„á¶œâ¸£ â‡„Bâ‡„) ] â‹… (pure â‹… ([,] â‹… x)) âŠ‘â™® pure â‹… ([,] â‹… x)
  Î±[,] x = Ï€â‚‚ Î·Î·á¶œ[ â‡„Bâ‡„ , idâ¸¢â‡„á¶œâ¸£ âˆ§â¸¢â‡„á¶œâ¸£ â‡„Bâ‡„ ] $ ext[â†—]â¸¢âŠ‘â¸£ $ Î» {y} â†’ Î·[,] x y

module _ {Î“} where
  âŸ¦_âŸ§Ê·â™¯ : wexp Î“ â†’ âŸª â‡§ (envâ™¯ Î“) â†— listâ™® (â‡§ (sexp Î“) âˆ§â™® â‡§ (envâ™¯ Î“)) âŸ«
  âŸ¦ Skip âŸ§Ê·â™¯ = singleâ™® âˆ˜â™® [,] â‹… []Ë¢â™®
  âŸ¦ Assign x ae âŸ§Ê·â™¯ =  applyâ™® âˆ˜â™® applyâ¸¢âˆ§â™®â¸£ â‹… âŸ¨ map[]â™® âˆ˜â™® (([,] â‹… []Ë¢â™®) âˆ˜âˆ˜â™® extendâ™¯[ x ]) ,â™® singleâ™® âˆ˜â™® âŸ¦ ae âŸ§áµƒâ™¯ âŸ© âˆ˜â™® splitâ™®
  âŸ¦ If be sâ‚ sâ‚‚ âŸ§Ê·â™¯ = applyâ™® âˆ˜â™® applyâ¸¢âˆ§â™®â¸£ â‹… âŸ¨ ifâˆ˜â™¯ â‹… ([,] â‹… â™®âŸ¨ sâ‚ âŸ©) â‹… ([,] â‹… â™®âŸ¨ sâ‚‚ âŸ©) ,â™® âŸ¦ be âŸ§áµ‡â™¯ âŸ© âˆ˜â™® splitâ™®
  âŸ¦ While be s âŸ§Ê·â™¯ = applyâ™® âˆ˜â™® applyâ¸¢âˆ§â™®â¸£ â‹… âŸ¨ ifâˆ˜â™¯ â‹… ([,] â‹… (â™®âŸ¨ s âŸ© â§ºË¢â™® â™®âŸ¨ While be s âˆ· [] âŸ©)) â‹… ([,] â‹… []Ë¢â™®) ,â™® âŸ¦ be âŸ§áµ‡â™¯ âŸ© âˆ˜â™® splitâ™®

  âŸ¦_âŸ§Ë¢â™¯ : sexp Î“ â†’ âŸª â‡§ (envâ™¯ Î“) â†— listâ™® (â‡§ (sexp Î“) âˆ§â™® â‡§ (envâ™¯ Î“)) âŸ«
  âŸ¦ [] âŸ§Ë¢â™¯ = constâ™® â‹… []â™®
  âŸ¦ w âˆ· s âŸ§Ë¢â™¯ = map[]â™® â‹… (firstâ™® â‹… (appendingË¢â™® â‹… â™®âŸ¨ s âŸ©)) âˆ˜â™® âŸ¦ w âŸ§Ê·â™¯

  Î±âŸ¦_âŸ§Ê·â™¯ : âˆ€ (w : wexp Î“) â†’ Î±[ â‡„envâ‡„ â†—â¸¢â‡„á¶œâ¸£ (idâ¸¢â‡„á¶œâ¸£ âˆ§â¸¢â‡„á¶œâ¸£ â‡„envâ‡„) ] â‹… âŸ¦ w âŸ§Ê· âŠ‘â™® pure[]â™® â‹… âŸ¦ w âŸ§Ê·â™¯
  Î±âŸ¦ Skip âŸ§Ê·â™¯ = ext[â†—]â¸¢âŠ‘â¸£ $ Î» {Ïâ™¯} â†’ let open ProofMode[âŠ‘] in [proof-mode]
    do [[ Î±[ â‡„envâ‡„ â†—â¸¢â‡„á¶œâ¸£ (idâ¸¢â‡„á¶œâ¸£ âˆ§â¸¢â‡„á¶œâ¸£ â‡„envâ‡„) ] â‹… âŸ¦ Skip âŸ§Ê· â‹… Ïâ™¯ ]]
     â€£ [[ Î±á¶œ[ idâ¸¢â‡„á¶œâ¸£ âˆ§â¸¢â‡„á¶œâ¸£ â‡„envâ‡„ ] *â™® â‹… (âŸ¦ Skip âŸ§Ê· *â™® â‹… (Î³á¶œ[ â‡„envâ‡„ ] â‹… Ïâ™¯)) ]]
     â€£ [focus-right [â‹…] ğ‘œğ‘“ Î±á¶œ[ idâ¸¢â‡„á¶œâ¸£ âˆ§â¸¢â‡„á¶œâ¸£ â‡„envâ‡„ ] *â™® ] begin
       do [[ âŸ¦ Skip âŸ§Ê· *â™® â‹… (Î³á¶œ[ â‡„envâ‡„ ] â‹… Ïâ™¯) ]]
        â€£ [focus-left [â‹…] ğ‘œğ‘“ (Î³á¶œ[ â‡„envâ‡„ ] â‹… Ïâ™¯) ] begin
          do [[ âŸ¦ Skip âŸ§Ê· *â™® ]]
          â€£ [focus-in [*] ] begin
            do [[ âŸ¦ Skip âŸ§Ê· ]]
             â€£ âŸ… Î²[Skip] âŸ†
             â€£ [[ pure â‹… ([,] â‹… []Ë¢â™®) ]]
            end
          â€£ [[ (pure â‹… ([,] â‹… []Ë¢â™®)) *â™® ]]
          end
        â€£ [[ (pure â‹… ([,] â‹… []Ë¢â™®)) *â™® â‹… (Î³á¶œ[ â‡„envâ‡„ ] â‹… Ïâ™¯) ]]
        â€£ âŸ… L1 â‡„envâ‡„ âŸ†â¸¢â‰ˆâ¸£
        â€£ [[ Î³á¶œ[ idâ¸¢â‡„á¶œâ¸£ âˆ§â¸¢â‡„á¶œâ¸£ â‡„envâ‡„ ] â‹… âŸ¨ []Ë¢â™® ,â™® Ïâ™¯ âŸ© ]]
       end
     â€£ [[ Î±á¶œ[ idâ¸¢â‡„á¶œâ¸£ âˆ§â¸¢â‡„á¶œâ¸£ â‡„envâ‡„ ] *â™® â‹… (Î³á¶œ[ idâ¸¢â‡„á¶œâ¸£ âˆ§â¸¢â‡„á¶œâ¸£ â‡„envâ‡„ ] â‹… âŸ¨ []Ë¢â™® ,â™® Ïâ™¯ âŸ©) ]] 
     â€£ âŸ… reductiveá¶œ[*][ idâ¸¢â‡„á¶œâ¸£ âˆ§â¸¢â‡„á¶œâ¸£ â‡„envâ‡„ ] âŸ†
     â€£ [[ returnâ™® â‹… âŸ¨ []Ë¢â™® ,â™® Ïâ™¯ âŸ© ]]
     â€£ âŸ… â—‡ return[]/single âŸ†â¸¢â‰ˆâ¸£
     â€£ [[ return[]â™® â‹… (singleâ™® â‹… âŸ¨ []Ë¢â™® ,â™® Ïâ™¯ âŸ©) ]]
     âˆ
  Î±âŸ¦ Assign x ae âŸ§Ê·â™¯ = ext[â†—]â¸¢âŠ‘â¸£ $ Î» {Ïâ™¯} â†’ let open ProofMode[âŠ‘] in [proof-mode]
    do [[ Î±[ â‡„envâ‡„ â†—â¸¢â‡„á¶œâ¸£ (idâ¸¢â‡„á¶œâ¸£ âˆ§â¸¢â‡„á¶œâ¸£ â‡„envâ‡„) ] â‹… âŸ¦ Assign x ae âŸ§Ê· â‹… Ïâ™¯ ]]
     â€£ [[ Î±á¶œ[ idâ¸¢â‡„á¶œâ¸£ âˆ§â¸¢â‡„á¶œâ¸£ â‡„envâ‡„ ] *â™® â‹… (âŸ¦ Assign x ae âŸ§Ê· *â™® â‹… (Î³á¶œ[ â‡„envâ‡„ ] â‹… Ïâ™¯)) ]]
     â€£ [focus-right [â‹…] ğ‘œğ‘“ Î±á¶œ[ idâ¸¢â‡„á¶œâ¸£ âˆ§â¸¢â‡„á¶œâ¸£ â‡„envâ‡„ ] *â™® ] begin
       do [[ âŸ¦ Assign x ae âŸ§Ê· *â™® â‹… (Î³á¶œ[ â‡„envâ‡„ ] â‹… Ïâ™¯) ]]
        â€£ [focus-left [â‹…] ğ‘œğ‘“ Î³á¶œ[ â‡„envâ‡„ ] â‹… Ïâ™¯ ] begin
          do [[ âŸ¦ Assign x ae âŸ§Ê· *â™® ]]
           â€£ [focus-in [*] ] begin
             do [[ âŸ¦ Assign x ae âŸ§Ê· ]]
              â€£ âŸ… Î²[Assign] âŸ†
              â€£ [[ mapâ„˜â™® â‹… ([,] â‹… []Ë¢â™®) âˆ˜â™® applyâ™® âˆ˜â™® applyâ¸¢âˆ§â™®â¸£ â‹… âŸ¨ [*] âˆ˜â™® pure âˆ˜â™® extendâ™®[ x ] ,â™® âŸ¦ ae âŸ§áµƒâ™® âŸ© âˆ˜â™® splitâ™® ]]
             end
           â€£ [[ (mapâ„˜â™® â‹… ([,] â‹… []Ë¢â™®) âˆ˜â™® applyâ™® âˆ˜â™® applyâ¸¢âˆ§â™®â¸£ â‹… âŸ¨ [*] âˆ˜â™® pure âˆ˜â™® extendâ™®[ x ] ,â™® âŸ¦ ae âŸ§áµƒâ™® âŸ© âˆ˜â™® splitâ™®) *â™® ]]
          end
        â€£ [[ (mapâ„˜â™® â‹… ([,] â‹… []Ë¢â™®) âˆ˜â™® applyâ™® âˆ˜â™® applyâ¸¢âˆ§â™®â¸£ â‹… âŸ¨ [*] âˆ˜â™® pure âˆ˜â™® extendâ™®[ x ] ,â™® âŸ¦ ae âŸ§áµƒâ™® âŸ© âˆ˜â™® splitâ™®) *â™® â‹… (Î³á¶œ[ â‡„envâ‡„ ] â‹… Ïâ™¯) ]]
        â€£ [[ ((pure â‹… ([,] â‹… []Ë¢â™®)) *â™® âˆ˜â™® applyâ™® âˆ˜â™® applyâ¸¢âˆ§â™®â¸£ â‹… âŸ¨ [*] âˆ˜â™® pure âˆ˜â™® extendâ™®[ x ] ,â™® âŸ¦ ae âŸ§áµƒâ™® âŸ© âˆ˜â™® splitâ™®) *â™® â‹… (Î³á¶œ[ â‡„envâ‡„ ] â‹… Ïâ™¯) ]]
        â€£ âŸ… associative[*] {g = pure â‹… ([,] â‹… []Ë¢â™®)} {f = applyâ™® âˆ˜â™® applyâ¸¢âˆ§â™®â¸£ â‹… âŸ¨ [*] âˆ˜â™® pure âˆ˜â™® extendâ™®[ x ] ,â™® âŸ¦ ae âŸ§áµƒâ™® âŸ© âˆ˜â™® splitâ™®} {X = (Î³á¶œ[ â‡„envâ‡„ ] â‹… Ïâ™¯)} âŸ†â¸¢â‰ˆâ¸£
        â€£ [[ (pure â‹… ([,] â‹… []Ë¢â™®)) *â™® â‹… ((applyâ™® âˆ˜â™® applyâ¸¢âˆ§â™®â¸£ â‹… âŸ¨ [*] âˆ˜â™® pure âˆ˜â™® extendâ™®[ x ] ,â™® âŸ¦ ae âŸ§áµƒâ™® âŸ© âˆ˜â™® splitâ™®) *â™® â‹… (Î³á¶œ[ â‡„envâ‡„ ] â‹… Ïâ™¯)) ]]
        â€£ [focus-right [â‹…] ğ‘œğ‘“ (pure â‹… ([,] â‹… []Ë¢â™®)) *â™® ] begin
          do [[ (applyâ™® âˆ˜â™® applyâ¸¢âˆ§â™®â¸£ â‹… âŸ¨ [*] âˆ˜â™® pure âˆ˜â™® extendâ™®[ x ] ,â™® âŸ¦ ae âŸ§áµƒâ™® âŸ© âˆ˜â™® splitâ™®) *â™® â‹… (Î³á¶œ[ â‡„envâ‡„ ] â‹… Ïâ™¯) ]]
           â€£ âŸ… L2 {g = pure âˆ˜â™® extendâ™®[ x ]} {f = âŸ¦ ae âŸ§áµƒâ™®} {X = Î³á¶œ[ â‡„envâ‡„ ] â‹… Ïâ™¯} âŸ†
           â€£ [[ (uncurryâ™® â‹… (pure âˆ˜â™® extendâ™®[ x ])) *â™® â‹… (Î³â¸¢IAâ¸£ â‹… âŸ¨ Î³á¶œ[ â‡„envâ‡„ ] â‹… Ïâ™¯ ,â™® âŸ¦ ae âŸ§áµƒâ™® *â™® â‹… (Î³á¶œ[ â‡„envâ‡„ ] â‹… Ïâ™¯) âŸ©) ]]
           â€£ [focus-right [â‹…] ğ‘œğ‘“ (uncurryâ™® â‹… (pure âˆ˜â™® extendâ™®[ x ])) *â™® ] begin
             do [focus-right [â‹…] ğ‘œğ‘“ Î³â¸¢IAâ¸£ ] $ [focus-right [,] ğ‘œğ‘“ Î³á¶œ[ â‡„envâ‡„ ] â‹… Ïâ™¯ ] begin
               do [[ âŸ¦ ae âŸ§áµƒâ™® *â™® â‹… (Î³á¶œ[ â‡„envâ‡„ ] â‹… Ïâ™¯) ]]
                â€£ âŸ… Ï€â‚ Î³Î³á¶œ[*][ â‡„envâ‡„ , â‡„â„¤â‡„ ] (Î±[âŸ¦âŸ§áµƒ] ae) âŸ†
                â€£ [[ Î³á¶œ[ â‡„â„¤â‡„ ] *â™® â‹… (pure â‹… âŸ¦ ae âŸ§áµƒâ™¯ â‹… Ïâ™¯) ]]
                â€£ âŸ… right-unit[*] âŸ†â¸¢â‰ˆâ¸£
                â€£ [[ Î³á¶œ[ â‡„â„¤â‡„ ] â‹… (âŸ¦ ae âŸ§áµƒâ™¯ â‹… Ïâ™¯) ]]
               end
             â€£ [[ Î³â¸¢IAâ¸£ â‹… âŸ¨ Î³á¶œ[ â‡„envâ‡„ ] â‹… Ïâ™¯ ,â™® Î³á¶œ[ â‡„â„¤â‡„ ] â‹… (âŸ¦ ae âŸ§áµƒâ™¯ â‹… Ïâ™¯) âŸ© ]]
             â€£ âŸ… L3 â‡„envâ‡„ â‡„â„¤â‡„ âŸ†â¸¢â‰ˆâ¸£
             â€£ [[ Î³á¶œ[ â‡„envâ‡„ âˆ§â¸¢â‡„á¶œâ¸£ â‡„â„¤â‡„ ] â‹… âŸ¨ Ïâ™¯ ,â™® âŸ¦ ae âŸ§áµƒâ™¯ â‹… Ïâ™¯ âŸ© ]]
             end
          â€£ [[ (uncurryâ™® â‹… (pure âˆ˜â™® extendâ™®[ x ])) *â™® â‹… (Î³á¶œ[ â‡„envâ‡„ âˆ§â¸¢â‡„á¶œâ¸£ â‡„â„¤â‡„ ] â‹… âŸ¨ Ïâ™¯ ,â™® âŸ¦ ae âŸ§áµƒâ™¯ â‹… Ïâ™¯ âŸ©) ]]
          â€£ [focus-left [*] ğ‘œğ‘“ Î³á¶œ[ â‡„envâ‡„ âˆ§â¸¢â‡„á¶œâ¸£ â‡„â„¤â‡„ ] â‹… âŸ¨ Ïâ™¯ ,â™® âŸ¦ ae âŸ§áµƒâ™¯ â‹… Ïâ™¯ âŸ© ] âŸ… L4 âŸ†â¸¢â‰ˆâ¸£
          â€£ [[ (pure â‹… (uncurryâ™® â‹… extendâ™®[ x ])) *â™® â‹… (Î³á¶œ[ â‡„envâ‡„ âˆ§â¸¢â‡„á¶œâ¸£ â‡„â„¤â‡„ ] â‹… âŸ¨ Ïâ™¯ ,â™® âŸ¦ ae âŸ§áµƒâ™¯ â‹… Ïâ™¯ âŸ©) ]]
          â€£ âŸ… Ï€â‚ (Î³Î³á¶œ[*][ â‡„envâ‡„ âˆ§â¸¢â‡„á¶œâ¸£ â‡„â„¤â‡„ , â‡„envâ‡„ ] {f = pure â‹… (uncurryâ™® â‹… extendâ™®[ x ])} {fâ™¯ = pure â‹… (uncurryâ™® â‹… extendâ™¯[ x ])}) 
              (Î±[extend] {x = x}) {x = âŸ¨ Ïâ™¯ ,â™® âŸ¦ ae âŸ§áµƒâ™¯ â‹… Ïâ™¯ âŸ©}
            âŸ†
          â€£ [[ Î³á¶œ[ â‡„envâ‡„ ] *â™® â‹… (returnâ™® â‹… (extendâ™¯[ x ] â‹… Ïâ™¯ â‹… (âŸ¦ ae âŸ§áµƒâ™¯ â‹… Ïâ™¯))) ]]
          â€£ âŸ… right-unit[*] âŸ†â¸¢â‰ˆâ¸£
          â€£ [[ Î³á¶œ[ â‡„envâ‡„ ] â‹… (extendâ™¯[ x ] â‹… Ïâ™¯ â‹… (âŸ¦ ae âŸ§áµƒâ™¯ â‹… Ïâ™¯)) ]]
          end
        â€£ [[ (pure â‹… ([,] â‹… []Ë¢â™®)) *â™® â‹… (Î³á¶œ[ â‡„envâ‡„ ] â‹… (extendâ™¯[ x ] â‹… Ïâ™¯ â‹… (âŸ¦ ae âŸ§áµƒâ™¯ â‹… Ïâ™¯))) ]]
        â€£ âŸ… L1 â‡„envâ‡„ âŸ†â¸¢â‰ˆâ¸£
        â€£ [[ Î³á¶œ[ idâ¸¢â‡„á¶œâ¸£ âˆ§â¸¢â‡„á¶œâ¸£ â‡„envâ‡„ ] â‹… âŸ¨ []Ë¢â™® ,â™® extendâ™¯[ x ] â‹… Ïâ™¯ â‹… (âŸ¦ ae âŸ§áµƒâ™¯ â‹… Ïâ™¯) âŸ© ]]
       end
     â€£ [[ Î±á¶œ[ idâ¸¢â‡„á¶œâ¸£ âˆ§â¸¢â‡„á¶œâ¸£ â‡„envâ‡„ ] *â™® â‹… (Î³á¶œ[ idâ¸¢â‡„á¶œâ¸£ âˆ§â¸¢â‡„á¶œâ¸£ â‡„envâ‡„ ] â‹… âŸ¨ []Ë¢â™® ,â™® extendâ™¯[ x ] â‹… Ïâ™¯ â‹… (âŸ¦ ae âŸ§áµƒâ™¯ â‹… Ïâ™¯) âŸ©) ]]
     â€£ âŸ… reductiveá¶œ[*][ idâ¸¢â‡„á¶œâ¸£ âˆ§â¸¢â‡„á¶œâ¸£ â‡„envâ‡„ ] âŸ†
     â€£ [[ returnâ™® â‹… âŸ¨ []Ë¢â™® ,â™® extendâ™¯[ x ] â‹… Ïâ™¯ â‹… (âŸ¦ ae âŸ§áµƒâ™¯ â‹… Ïâ™¯) âŸ© ]]
     â€£ âŸ… â—‡ return[]/single âŸ†â¸¢â‰ˆâ¸£
     â€£ [[ return[]â™® â‹… (singleâ™® â‹… âŸ¨ []Ë¢â™® ,â™® extendâ™¯[ x ] â‹… Ïâ™¯ â‹… (âŸ¦ ae âŸ§áµƒâ™¯ â‹… Ïâ™¯) âŸ©) ]]
     â€£ [[ return[]â™® â‹… (applyâ™® â‹… (applyâ¸¢âˆ§â™®â¸£ â‹… âŸ¨ map[]â™® âˆ˜â™® (([,] â‹… []Ë¢â™®) âˆ˜âˆ˜â™® extendâ™¯[ x ]) ,â™® singleâ™® âˆ˜â™® âŸ¦ ae âŸ§áµƒâ™¯ âŸ© â‹… âŸ¨ Ïâ™¯ ,â™® Ïâ™¯ âŸ©)) ]]
     âˆ
  Î±âŸ¦ If be sâ‚ sâ‚‚ âŸ§Ê·â™¯ = ext[â†—]â¸¢âŠ‘â¸£ $ Î» {Ïâ™¯} â†’ let open ProofMode[âŠ‘] in [proof-mode]
    do [[ Î±[ â‡„envâ‡„ â†—â¸¢â‡„á¶œâ¸£ (idâ¸¢â‡„á¶œâ¸£ âˆ§â¸¢â‡„á¶œâ¸£ â‡„envâ‡„) ] â‹… âŸ¦ If be sâ‚ sâ‚‚ âŸ§Ê· â‹… Ïâ™¯ ]]
     â€£ [[ Î±á¶œ[ idâ¸¢â‡„á¶œâ¸£ âˆ§â¸¢â‡„á¶œâ¸£ â‡„envâ‡„ ] *â™® â‹… (âŸ¦ If be sâ‚ sâ‚‚ âŸ§Ê· *â™® â‹… (Î³á¶œ[ â‡„envâ‡„ ] â‹… Ïâ™¯)) ]]
     â€£ [focus-right [â‹…] ğ‘œğ‘“ Î±á¶œ[ idâ¸¢â‡„á¶œâ¸£ âˆ§â¸¢â‡„á¶œâ¸£ â‡„envâ‡„ ] *â™® ] begin
       do [[ âŸ¦ If be sâ‚ sâ‚‚ âŸ§Ê· *â™® â‹… (Î³á¶œ[ â‡„envâ‡„ ] â‹… Ïâ™¯) ]]
        â€£ [focus-left [*] ğ‘œğ‘“ Î³á¶œ[ â‡„envâ‡„ ] â‹… Ïâ™¯ ] begin
          do [[ âŸ¦ If be sâ‚ sâ‚‚ âŸ§Ê· ]]
           â€£ âŸ… Î²[If] âŸ†
           â€£ [[ applyâ™® âˆ˜â™® applyâ¸¢âˆ§â™®â¸£ â‹… âŸ¨ [*] âˆ˜â™® pure âˆ˜â™® ifâˆ˜â™® â‹… ([,] â‹… â™®âŸ¨ sâ‚ âŸ©) â‹… ([,] â‹… â™®âŸ¨ sâ‚‚ âŸ©) ,â™® âŸ¦ be âŸ§áµ‡ âŸ© âˆ˜â™® splitâ™® ]]
          end
        â€£ [[ (applyâ™® âˆ˜â™® applyâ¸¢âˆ§â™®â¸£ â‹… âŸ¨ [*] âˆ˜â™® pure âˆ˜â™® ifâˆ˜â™® â‹… ([,] â‹… â™®âŸ¨ sâ‚ âŸ©) â‹… ([,] â‹… â™®âŸ¨ sâ‚‚ âŸ©) ,â™® âŸ¦ be âŸ§áµ‡ âŸ© âˆ˜â™® splitâ™®) *â™® â‹… (Î³á¶œ[ â‡„envâ‡„ ] â‹… Ïâ™¯) ]]
        â€£ âŸ… L2 {g = pure âˆ˜â™® ifâˆ˜â™® â‹… ([,] â‹… â™®âŸ¨ sâ‚ âŸ©) â‹… ([,] â‹… â™®âŸ¨ sâ‚‚ âŸ©)} {f = âŸ¦ be âŸ§áµ‡} {X = Î³á¶œ[ â‡„envâ‡„ ] â‹… Ïâ™¯} âŸ†
        â€£ [[ (uncurryâ™® â‹… (pure âˆ˜â™® ifâˆ˜â™® â‹… ([,] â‹… â™®âŸ¨ sâ‚ âŸ©) â‹… ([,] â‹… â™®âŸ¨ sâ‚‚ âŸ©))) *â™® â‹… (Î³â¸¢IAâ¸£ â‹… âŸ¨ Î³á¶œ[ â‡„envâ‡„ ] â‹… Ïâ™¯  ,â™® âŸ¦ be âŸ§áµ‡ *â™® â‹… (Î³á¶œ[ â‡„envâ‡„ ] â‹… Ïâ™¯) âŸ©) ]]
        â€£ [focus-right [â‹…] ğ‘œğ‘“ (uncurryâ™® â‹… (pure âˆ˜â™® ifâˆ˜â™® â‹… ([,] â‹… â™®âŸ¨ sâ‚ âŸ©) â‹… ([,] â‹… â™®âŸ¨ sâ‚‚ âŸ©))) *â™® ] begin
          do [[ Î³â¸¢IAâ¸£ â‹… âŸ¨ Î³á¶œ[ â‡„envâ‡„ ] â‹… Ïâ™¯  ,â™® âŸ¦ be âŸ§áµ‡ *â™® â‹… (Î³á¶œ[ â‡„envâ‡„ ] â‹… Ïâ™¯) âŸ© ]]
           â€£ [focus-right [â‹…] ğ‘œğ‘“ Î³â¸¢IAâ¸£ ] $ [focus-right [,] ğ‘œğ‘“ Î³á¶œ[ â‡„envâ‡„ ] â‹… Ïâ™¯ ] begin
             do [[ âŸ¦ be âŸ§áµ‡ *â™® â‹… (Î³á¶œ[ â‡„envâ‡„ ] â‹… Ïâ™¯) ]]
              â€£ âŸ… Ï€â‚ (Î³Î³á¶œ[*][ â‡„envâ‡„ , â‡„ğ”¹â‡„ ] {f = âŸ¦ be âŸ§áµ‡} {fâ™¯ = pure â‹… âŸ¦ be âŸ§áµ‡â™¯}) (Î±[âŸ¦âŸ§áµ‡] be) {x = Ïâ™¯} âŸ†
              â€£ [[ Î³á¶œ[ â‡„ğ”¹â‡„ ] *â™® â‹… (pure â‹… âŸ¦ be âŸ§áµ‡â™¯ â‹… Ïâ™¯) ]]
              â€£ âŸ… right-unit[*] âŸ†â¸¢â‰ˆâ¸£
              â€£ [[ Î³á¶œ[ â‡„ğ”¹â‡„ ] â‹… (âŸ¦ be âŸ§áµ‡â™¯ â‹… Ïâ™¯) ]]
             end
           â€£ [[ Î³â¸¢IAâ¸£ â‹… âŸ¨ Î³á¶œ[ â‡„envâ‡„ ] â‹… Ïâ™¯  ,â™® Î³á¶œ[ â‡„ğ”¹â‡„ ] â‹… (âŸ¦ be âŸ§áµ‡â™¯ â‹… Ïâ™¯) âŸ© ]]
           â€£ âŸ… L3 â‡„envâ‡„ â‡„ğ”¹â‡„ âŸ†â¸¢â‰ˆâ¸£
           â€£ [[ Î³á¶œ[ â‡„envâ‡„ âˆ§â¸¢â‡„á¶œâ¸£ â‡„ğ”¹â‡„ ] â‹… âŸ¨ Ïâ™¯  ,â™® âŸ¦ be âŸ§áµ‡â™¯ â‹… Ïâ™¯ âŸ© ]]
          end
        â€£ [[ (uncurryâ™® â‹… (pure âˆ˜â™® ifâˆ˜â™® â‹… ([,] â‹… â™®âŸ¨ sâ‚ âŸ©) â‹… ([,] â‹… â™®âŸ¨ sâ‚‚ âŸ©))) *â™® â‹… (Î³á¶œ[ â‡„envâ‡„ âˆ§â¸¢â‡„á¶œâ¸£ â‡„ğ”¹â‡„ ] â‹… âŸ¨ Ïâ™¯  ,â™® âŸ¦ be âŸ§áµ‡â™¯ â‹… Ïâ™¯ âŸ©) ]]
        â€£ [focus-left [*] ğ‘œğ‘“ Î³á¶œ[ â‡„envâ‡„ âˆ§â¸¢â‡„á¶œâ¸£ â‡„ğ”¹â‡„ ] â‹… âŸ¨ Ïâ™¯  ,â™® âŸ¦ be âŸ§áµ‡â™¯ â‹… Ïâ™¯ âŸ© ] âŸ… L4 âŸ†â¸¢â‰ˆâ¸£
        â€£ [[ (pure â‹… (uncurryâ™® â‹… (ifâˆ˜â™® â‹… ([,] â‹… â™®âŸ¨ sâ‚ âŸ©) â‹… ([,] â‹… â™®âŸ¨ sâ‚‚ âŸ©)))) *â™® â‹… (Î³á¶œ[ â‡„envâ‡„ âˆ§â¸¢â‡„á¶œâ¸£ â‡„ğ”¹â‡„ ] â‹… âŸ¨ Ïâ™¯  ,â™® âŸ¦ be âŸ§áµ‡â™¯ â‹… Ïâ™¯ âŸ©) ]]
        â€£ âŸ… Ï€â‚ (Î³Î³á¶œ[*][ â‡„envâ‡„ âˆ§â¸¢â‡„á¶œâ¸£ â‡„ğ”¹â‡„ , idâ¸¢â‡„á¶œâ¸£ âˆ§â¸¢â‡„á¶œâ¸£ â‡„envâ‡„ ]
                {f = pure â‹… (uncurryâ™® â‹… (ifâˆ˜â™® â‹… ([,] â‹… â™®âŸ¨ sâ‚ âŸ©) â‹… ([,] â‹… â™®âŸ¨ sâ‚‚ âŸ©)))}
                {fâ™¯ = pure[]â™® â‹… (uncurryâ™® â‹… (ifâˆ˜â™¯ â‹… ([,] â‹… â™®âŸ¨ sâ‚ âŸ©) â‹… ([,] â‹… â™®âŸ¨ sâ‚‚ âŸ©)))}) 
            (Î±[ifâˆ˜] â‡„envâ‡„ (idâ¸¢â‡„á¶œâ¸£ âˆ§â¸¢â‡„á¶œâ¸£ â‡„envâ‡„) ([,] â‹… â™®âŸ¨ sâ‚ âŸ©) ([,] â‹… â™®âŸ¨ sâ‚‚ âŸ©) ([,] â‹… â™®âŸ¨ sâ‚ âŸ©) ([,] â‹… â™®âŸ¨ sâ‚‚ âŸ©) (Î±[,] â‡„envâ‡„ â™®âŸ¨ sâ‚ âŸ©) (Î±[,] â‡„envâ‡„ â™®âŸ¨ sâ‚‚ âŸ©))
            {x = âŸ¨ Ïâ™¯ ,â™® âŸ¦ be âŸ§áµ‡â™¯ â‹… Ïâ™¯ âŸ©}
          âŸ†
        â€£ [[ Î³á¶œ[ idâ¸¢â‡„á¶œâ¸£ âˆ§â¸¢â‡„á¶œâ¸£ â‡„envâ‡„ ] *â™® â‹… (return[]â™® â‹… (ifâˆ˜â™¯ â‹… ([,] â‹… â™®âŸ¨ sâ‚ âŸ©) â‹… ([,] â‹… â™®âŸ¨ sâ‚‚ âŸ©) â‹… Ïâ™¯ â‹… (âŸ¦ be âŸ§áµ‡â™¯ â‹… Ïâ™¯))) ]]
       end
     â€£ [[ Î±á¶œ[ idâ¸¢â‡„á¶œâ¸£ âˆ§â¸¢â‡„á¶œâ¸£ â‡„envâ‡„ ] *â™® â‹… (Î³á¶œ[ idâ¸¢â‡„á¶œâ¸£ âˆ§â¸¢â‡„á¶œâ¸£ â‡„envâ‡„ ] *â™® â‹… (return[]â™® â‹… (ifâˆ˜â™¯ â‹… ([,] â‹… â™®âŸ¨ sâ‚ âŸ©) â‹… ([,] â‹… â™®âŸ¨ sâ‚‚ âŸ©) â‹… Ïâ™¯ â‹… (âŸ¦ be âŸ§áµ‡â™¯ â‹… Ïâ™¯)))) ]]
     â€£ âŸ… reductiveá¶œ[â‹…][ idâ¸¢â‡„á¶œâ¸£ âˆ§â¸¢â‡„á¶œâ¸£ â‡„envâ‡„ ] âŸ†
     â€£ [[ return[]â™® â‹… (ifâˆ˜â™¯ â‹… ([,] â‹… â™®âŸ¨ sâ‚ âŸ©) â‹… ([,] â‹… â™®âŸ¨ sâ‚‚ âŸ©) â‹… Ïâ™¯ â‹… (âŸ¦ be âŸ§áµ‡â™¯ â‹… Ïâ™¯)) ]]
     â€£ [[ return[]â™® â‹… (applyâ™® â‹… (applyâ¸¢âˆ§â™®â¸£ â‹… âŸ¨ ifâˆ˜â™¯ â‹… ([,] â‹… â™®âŸ¨ sâ‚ âŸ©) â‹… ([,] â‹… â™®âŸ¨ sâ‚‚ âŸ©) ,â™® âŸ¦ be âŸ§áµ‡â™¯ âŸ© â‹… (splitâ™® â‹… Ïâ™¯))) ]]
     âˆ
  Î±âŸ¦ While be s âŸ§Ê·â™¯ = ext[â†—]â¸¢âŠ‘â¸£ $ Î» {Ïâ™¯} â†’ let open ProofMode[âŠ‘] in [proof-mode]
    do [[ Î±[ â‡„envâ‡„ â†—â¸¢â‡„á¶œâ¸£ (idâ¸¢â‡„á¶œâ¸£ âˆ§â¸¢â‡„á¶œâ¸£ â‡„envâ‡„) ] â‹… âŸ¦ While be s âŸ§Ê· â‹… Ïâ™¯ ]]
     â€£ [[ Î±á¶œ[ idâ¸¢â‡„á¶œâ¸£ âˆ§â¸¢â‡„á¶œâ¸£ â‡„envâ‡„ ] *â™® â‹… (âŸ¦ While be s âŸ§Ê· *â™® â‹… (Î³á¶œ[ â‡„envâ‡„ ] â‹… Ïâ™¯)) ]]
     â€£ [focus-right [â‹…] ğ‘œğ‘“ Î±á¶œ[ idâ¸¢â‡„á¶œâ¸£ âˆ§â¸¢â‡„á¶œâ¸£ â‡„envâ‡„ ] *â™® ] begin
       do [[ âŸ¦ While be s âŸ§Ê· *â™® â‹… (Î³á¶œ[ â‡„envâ‡„ ] â‹… Ïâ™¯) ]]
        â€£ [focus-left [*] ğ‘œğ‘“ Î³á¶œ[ â‡„envâ‡„ ] â‹… Ïâ™¯ ] begin
          do [[ âŸ¦ While be s âŸ§Ê· ]]
           â€£ âŸ… Î²[While] âŸ†
           â€£ [[ applyâ™® âˆ˜â™® applyâ¸¢âˆ§â™®â¸£ â‹… âŸ¨ [*] âˆ˜â™® pure âˆ˜â™® ifâˆ˜â™® â‹… ([,] â‹… (â™®âŸ¨ s âŸ© â§ºË¢â™® â™®âŸ¨ While be s âˆ· [] âŸ©)) â‹… ([,] â‹… []Ë¢â™®) ,â™® âŸ¦ be âŸ§áµ‡ âŸ© âˆ˜â™® splitâ™® ]]
          end
        â€£ [[ (applyâ™® âˆ˜â™® applyâ¸¢âˆ§â™®â¸£ â‹… âŸ¨ [*] âˆ˜â™® pure âˆ˜â™® ifâˆ˜â™® â‹… ([,] â‹… (â™®âŸ¨ s âŸ© â§ºË¢â™® â™®âŸ¨ While be s âˆ· [] âŸ©)) â‹… ([,] â‹… []Ë¢â™®) ,â™® âŸ¦ be âŸ§áµ‡ âŸ© âˆ˜â™® splitâ™®) *â™® â‹… (Î³á¶œ[ â‡„envâ‡„ ] â‹… Ïâ™¯) ]]
        â€£ âŸ… L2 {g = pure âˆ˜â™® ifâˆ˜â™® â‹… ([,] â‹… (â™®âŸ¨ s âŸ© â§ºË¢â™® â™®âŸ¨ While be s âˆ· [] âŸ©)) â‹… ([,] â‹… []Ë¢â™®)} {f = âŸ¦ be âŸ§áµ‡} {X = Î³á¶œ[ â‡„envâ‡„ ] â‹… Ïâ™¯} âŸ†
        â€£ [[ (uncurryâ™® â‹… (pure âˆ˜â™® ifâˆ˜â™® â‹… ([,] â‹… (â™®âŸ¨ s âŸ© â§ºË¢â™® â™®âŸ¨ While be s âˆ· [] âŸ©)) â‹… ([,] â‹… []Ë¢â™®))) *â™® â‹… (Î³â¸¢IAâ¸£ â‹… âŸ¨ Î³á¶œ[ â‡„envâ‡„ ] â‹… Ïâ™¯  ,â™® âŸ¦ be âŸ§áµ‡ *â™® â‹… (Î³á¶œ[ â‡„envâ‡„ ] â‹… Ïâ™¯) âŸ©) ]]
        â€£ [focus-right [â‹…] ğ‘œğ‘“ (uncurryâ™® â‹… (pure âˆ˜â™® ifâˆ˜â™® â‹… ([,] â‹… (â™®âŸ¨ s âŸ© â§ºË¢â™® â™®âŸ¨ While be s âˆ· [] âŸ©)) â‹… ([,] â‹… []Ë¢â™®))) *â™® ] begin
          do [[ Î³â¸¢IAâ¸£ â‹… âŸ¨ Î³á¶œ[ â‡„envâ‡„ ] â‹… Ïâ™¯  ,â™® âŸ¦ be âŸ§áµ‡ *â™® â‹… (Î³á¶œ[ â‡„envâ‡„ ] â‹… Ïâ™¯) âŸ© ]]
           â€£ [focus-right [â‹…] ğ‘œğ‘“ Î³â¸¢IAâ¸£ ] $ [focus-right [,] ğ‘œğ‘“ Î³á¶œ[ â‡„envâ‡„ ] â‹… Ïâ™¯ ] begin
             do [[ âŸ¦ be âŸ§áµ‡ *â™® â‹… (Î³á¶œ[ â‡„envâ‡„ ] â‹… Ïâ™¯) ]]
              â€£ âŸ… Ï€â‚ (Î³Î³á¶œ[*][ â‡„envâ‡„ , â‡„ğ”¹â‡„ ] {f = âŸ¦ be âŸ§áµ‡} {fâ™¯ = pure â‹… âŸ¦ be âŸ§áµ‡â™¯}) (Î±[âŸ¦âŸ§áµ‡] be) {x = Ïâ™¯} âŸ†
              â€£ [[ Î³á¶œ[ â‡„ğ”¹â‡„ ] *â™® â‹… (pure â‹… âŸ¦ be âŸ§áµ‡â™¯ â‹… Ïâ™¯) ]]
              â€£ âŸ… right-unit[*] âŸ†â¸¢â‰ˆâ¸£
              â€£ [[ Î³á¶œ[ â‡„ğ”¹â‡„ ] â‹… (âŸ¦ be âŸ§áµ‡â™¯ â‹… Ïâ™¯) ]]
             end
           â€£ [[ Î³â¸¢IAâ¸£ â‹… âŸ¨ Î³á¶œ[ â‡„envâ‡„ ] â‹… Ïâ™¯  ,â™® Î³á¶œ[ â‡„ğ”¹â‡„ ] â‹… (âŸ¦ be âŸ§áµ‡â™¯ â‹… Ïâ™¯) âŸ© ]]
           â€£ âŸ… L3 â‡„envâ‡„ â‡„ğ”¹â‡„ âŸ†â¸¢â‰ˆâ¸£
           â€£ [[ Î³á¶œ[ â‡„envâ‡„ âˆ§â¸¢â‡„á¶œâ¸£ â‡„ğ”¹â‡„ ] â‹… âŸ¨ Ïâ™¯  ,â™® âŸ¦ be âŸ§áµ‡â™¯ â‹… Ïâ™¯ âŸ© ]]
          end
        â€£ [[ (uncurryâ™® â‹… (pure âˆ˜â™® ifâˆ˜â™® â‹… ([,] â‹… (â™®âŸ¨ s âŸ© â§ºË¢â™® â™®âŸ¨ While be s âˆ· [] âŸ©)) â‹… ([,] â‹… []Ë¢â™®))) *â™® â‹… (Î³á¶œ[ â‡„envâ‡„ âˆ§â¸¢â‡„á¶œâ¸£ â‡„ğ”¹â‡„ ] â‹… âŸ¨ Ïâ™¯  ,â™® âŸ¦ be âŸ§áµ‡â™¯ â‹… Ïâ™¯ âŸ©) ]]
        â€£ [focus-left [*] ğ‘œğ‘“ Î³á¶œ[ â‡„envâ‡„ âˆ§â¸¢â‡„á¶œâ¸£ â‡„ğ”¹â‡„ ] â‹… âŸ¨ Ïâ™¯  ,â™® âŸ¦ be âŸ§áµ‡â™¯ â‹… Ïâ™¯ âŸ© ] âŸ… L4 âŸ†â¸¢â‰ˆâ¸£
        â€£ [[ (pure â‹… (uncurryâ™® â‹… (ifâˆ˜â™® â‹… ([,] â‹… (â™®âŸ¨ s âŸ© â§ºË¢â™® â™®âŸ¨ While be s âˆ· [] âŸ©)) â‹… ([,] â‹… []Ë¢â™®)))) *â™® â‹… (Î³á¶œ[ â‡„envâ‡„ âˆ§â¸¢â‡„á¶œâ¸£ â‡„ğ”¹â‡„ ] â‹… âŸ¨ Ïâ™¯  ,â™® âŸ¦ be âŸ§áµ‡â™¯ â‹… Ïâ™¯ âŸ©) ]]
        â€£ âŸ… Ï€â‚ (Î³Î³á¶œ[*][ â‡„envâ‡„ âˆ§â¸¢â‡„á¶œâ¸£ â‡„ğ”¹â‡„ , idâ¸¢â‡„á¶œâ¸£ âˆ§â¸¢â‡„á¶œâ¸£ â‡„envâ‡„ ]
                {f = pure â‹… (uncurryâ™® â‹… (ifâˆ˜â™® â‹… ([,] â‹… (â™®âŸ¨ s âŸ© â§ºË¢â™® â™®âŸ¨ While be s âˆ· [] âŸ©)) â‹… ([,] â‹… []Ë¢â™®)))}
                {fâ™¯ = pure[]â™® â‹… (uncurryâ™® â‹… (ifâˆ˜â™¯ â‹… ([,] â‹… (â™®âŸ¨ s âŸ© â§ºË¢â™® â™®âŸ¨ While be s âˆ· [] âŸ©)) â‹… ([,] â‹… []Ë¢â™®)))}) 
            (Î±[ifâˆ˜] â‡„envâ‡„ (idâ¸¢â‡„á¶œâ¸£ âˆ§â¸¢â‡„á¶œâ¸£ â‡„envâ‡„)
                    ([,] â‹… (â™®âŸ¨ s âŸ© â§ºË¢â™® â™®âŸ¨ While be s âˆ· [] âŸ©)) ([,] â‹… []Ë¢â™®)
                    ([,] â‹… (â™®âŸ¨ s âŸ© â§ºË¢â™® â™®âŸ¨ While be s âˆ· [] âŸ©)) ([,] â‹… []Ë¢â™®)
                    (Î±[,] â‡„envâ‡„ (â™®âŸ¨ s âŸ© â§ºË¢â™® â™®âŸ¨ While be s âˆ· [] âŸ©)) (Î±[,] â‡„envâ‡„ []Ë¢â™®))
            {x = âŸ¨ Ïâ™¯ ,â™® âŸ¦ be âŸ§áµ‡â™¯ â‹… Ïâ™¯ âŸ©}
          âŸ†
        â€£ [[ Î³á¶œ[ idâ¸¢â‡„á¶œâ¸£ âˆ§â¸¢â‡„á¶œâ¸£ â‡„envâ‡„ ] *â™® â‹… (return[]â™® â‹… (ifâˆ˜â™¯ â‹… ([,] â‹… (â™®âŸ¨ s âŸ© â§ºË¢â™® â™®âŸ¨ While be s âˆ· [] âŸ©)) â‹… ([,] â‹… []Ë¢â™®) â‹… Ïâ™¯ â‹… (âŸ¦ be âŸ§áµ‡â™¯ â‹… Ïâ™¯))) ]]
       end
     â€£ [[ Î±á¶œ[ idâ¸¢â‡„á¶œâ¸£ âˆ§â¸¢â‡„á¶œâ¸£ â‡„envâ‡„ ] *â™® â‹… (Î³á¶œ[ idâ¸¢â‡„á¶œâ¸£ âˆ§â¸¢â‡„á¶œâ¸£ â‡„envâ‡„ ] *â™® â‹… (return[]â™® â‹… (ifâˆ˜â™¯ â‹… ([,] â‹… (â™®âŸ¨ s âŸ© â§ºË¢â™® â™®âŸ¨ While be s âˆ· [] âŸ©)) â‹… ([,] â‹… []Ë¢â™®) â‹… Ïâ™¯ â‹… (âŸ¦ be âŸ§áµ‡â™¯ â‹… Ïâ™¯)))) ]]
     â€£ âŸ… reductiveá¶œ[â‹…][ idâ¸¢â‡„á¶œâ¸£ âˆ§â¸¢â‡„á¶œâ¸£ â‡„envâ‡„ ] âŸ†
     â€£ [[ return[]â™® â‹… (ifâˆ˜â™¯ â‹… ([,] â‹… (â™®âŸ¨ s âŸ© â§ºË¢â™® â™®âŸ¨ While be s âˆ· [] âŸ©)) â‹… ([,] â‹… []Ë¢â™®) â‹… Ïâ™¯ â‹… (âŸ¦ be âŸ§áµ‡â™¯ â‹… Ïâ™¯)) ]]
     â€£ [[ return[]â™® â‹… (applyâ™® â‹… (applyâ¸¢âˆ§â™®â¸£ â‹… âŸ¨ ifâˆ˜â™¯ â‹… ([,] â‹… (â™®âŸ¨ s âŸ© â§ºË¢â™® â™®âŸ¨ While be s âˆ· [] âŸ©)) â‹… ([,] â‹… []Ë¢â™®) ,â™® âŸ¦ be âŸ§áµ‡â™¯ âŸ© â‹… (splitâ™® â‹… Ïâ™¯))) ]]
     âˆ
