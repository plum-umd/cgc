module CDGAI.ASemantics where

open import Prelude
open import Poset
open import CDGAI.ASyntax

âŸ¦_âŸ§áµƒÂ¹ : unary â†’ â„¤ â†’ â„¤
âŸ¦ [+] âŸ§áµƒÂ¹ = sucá¶»
âŸ¦ [-] âŸ§áµƒÂ¹ = predá¶»

data _âˆˆâŸ¦_âŸ§áµƒÂ²[_,_] : â„¤ â†’ binary â†’ â„¤ â†’ â„¤ â†’ Set where
  [+] : âˆ€ {nâ‚ nâ‚‚} â†’ (nâ‚ + nâ‚‚) âˆˆâŸ¦ [+] âŸ§áµƒÂ²[ nâ‚ , nâ‚‚ ]
  [-] : âˆ€ {nâ‚ nâ‚‚} â†’ (nâ‚ - nâ‚‚) âˆˆâŸ¦ [-] âŸ§áµƒÂ²[ nâ‚ , nâ‚‚ ]
  [Ã—] : âˆ€ {nâ‚ nâ‚‚} â†’ (nâ‚ Ã— nâ‚‚) âˆˆâŸ¦ [Ã—] âŸ§áµƒÂ²[ nâ‚ , nâ‚‚ ]
  [/] : âˆ€ {nâ‚ nâ‚‚} (nâ‚‚â‰ 0 : nâ‚‚ â‰¢ Zero) â†’ (nâ‚ / nâ‚‚ â€– nâ‚‚â‰ 0) âˆˆâŸ¦ [/] âŸ§áµƒÂ²[ nâ‚ , nâ‚‚ ]
  [%] : âˆ€ {nâ‚ nâ‚‚} (nâ‚‚â‰ 0 : nâ‚‚ â‰¢ Zero) â†’ (nâ‚ % nâ‚‚ â€– nâ‚‚â‰ 0) âˆˆâŸ¦ [%] âŸ§áµƒÂ²[ nâ‚ , nâ‚‚ ]

data env : context â†’ Set where
  [] : env zero
  _âˆ·_ : âˆ€ {Î“} â†’ â„¤ â†’ env Î“ â†’ env (Succ Î“)

instance
  env-PreOrder : âˆ€ {Î“} â†’ PreOrder 0á´¸ (env Î“)
  env-PreOrder = PreOrder[â‰¡]

_[_] : âˆ€ {Î“} â†’ env Î“ â†’ var Î“ â†’ â„¤
(n âˆ· Ï) [ Zero ] = n
(n âˆ· Ï) [ Succ x ] = Ï [ x ]

_[_â†¦_] : âˆ€ {Î“} â†’ env Î“ â†’ var Î“ â†’ â„¤ â†’ env Î“
(i âˆ· Ï) [ Zero â†¦ i' ] = i' âˆ· Ï
(i âˆ· Ï) [ Succ x â†¦ i' ] = i âˆ· Ï [ x â†¦ i' ]

data _âŠ¢_â‡“áµƒ_ {Î“} : env Î“ â†’ aexp Î“ â†’ â„¤ â†’ Set where
  Num : âˆ€ {Ï n} â†’ Ï âŠ¢ Num n â‡“áµƒ n
  Var : âˆ€ {Ï x} â†’ Ï âŠ¢ Var x â‡“áµƒ Ï [ x ]
  âŠ¤â„¤ : âˆ€ {Ï n} â†’ Ï âŠ¢ âŠ¤â„¤ â‡“áµƒ n
  Unary : âˆ€ {Ï o e n} â†’ Ï âŠ¢ e â‡“áµƒ n â†’ Ï âŠ¢ Unary[ o ] e â‡“áµƒ âŸ¦ o âŸ§áµƒÂ¹ n
  Binary : âˆ€ {Ï o eâ‚ eâ‚‚ nâ‚ nâ‚‚ nâ‚ƒ} â†’ Ï âŠ¢ eâ‚ â‡“áµƒ nâ‚ â†’ Ï âŠ¢ eâ‚‚ â‡“áµƒ nâ‚‚ â†’ nâ‚ƒ âˆˆâŸ¦ o âŸ§áµƒÂ²[ nâ‚ , nâ‚‚ ] â†’ Ï âŠ¢ Binary[ o ] eâ‚ eâ‚‚ â‡“áµƒ nâ‚ƒ

-- Ordered Universe --

âŸ¦_âŸ§áµƒÂ¹â™® : unary â†’ âŸª â‡§ â„¤ â†— â‡§ â„¤ âŸ«
âŸ¦ o âŸ§áµƒÂ¹â™® = witness (curryâ¸¢Î»â™­â¸£ idâ¸¢Î»â™­â¸£) $ mk[witness] âŸ¦ o âŸ§áµƒÂ¹ res[â€¢x]

âŸ¦_âŸ§áµƒÂ²â™® : binary â†’ âŸª â‡§ â„¤ â†— â‡§ â„¤ â†— â„˜ (â‡§ â„¤) âŸ« 
âŸ¦ o âŸ§áµƒÂ²â™® = witness (curryâ¸¢Î»â™­â¸£ $ curryâ¸¢Î»â™­â¸£ idâ¸¢Ï‰â™­â¸£) $ mk[witness] (Î» x y z â†’ z âˆˆâŸ¦ o âŸ§áµƒÂ²[ x , y ]) ppr
  where
    abstract
      ppr : proper (_â‰¼_ â‡‰ _â‰¼_ â‡‰ _â‰½_ â‡‰ [â†’]) (Î» x y z â†’ z âˆˆâŸ¦ o âŸ§áµƒÂ²[ x , y ])
      ppr â†¯ â†¯ â†¯ = id

lookup[_]â™® : âˆ€ {Î“} â†’ var Î“ â†’ âŸª â‡§ (env Î“) â†— â‡§ â„¤ âŸ«
lookup[ x ]â™® = witness (curryâ¸¢Î»â™­â¸£ idâ¸¢Î»â™­â¸£) $ mk[witness] (Î» Ï â†’ Ï [ x ]) res[â€¢x]

âŸ¦_âŸ§áµƒâ™® : âˆ€ {Î“} â†’ aexp Î“ â†’ âŸª â‡§ (env Î“) â†— â„˜ (â‡§ â„¤) âŸ«
âŸ¦ e âŸ§áµƒâ™® = witness (curryâ¸¢Î»â™­â¸£ idâ¸¢Ï‰â™­â¸£) $ mk[witness] (Î» Ï n â†’ Ï âŠ¢ e â‡“áµƒ n) ppr
    where
      ppr : proper (_â‰¼_ â‡‰ flip _â‰¼_ â‡‰ [â†’]) (Î» Ï n â†’ Ï âŠ¢ e â‡“áµƒ n)
      ppr â†¯ â†¯ = id

ğ’âŸ¦NumâŸ§â¸¢âŠ‘â¸£ : âˆ€ {Î“} {n : â„¤} {R : âŸª â„˜ (â‡§ (env Î“)) âŸ«} â†’ âŸ¦ Num n âŸ§áµƒâ™® *â™® â‹… R âŠ‘â™® returnâ™® â‹… â™® n
ğ’âŸ¦NumâŸ§â¸¢âŠ‘â¸£ {Î“} {n} {R} = extâ¸¢âŠ‘â„˜â¸£ H
  where
    H : âˆ€ {n'} â†’ n' â‹¿ âŸ¦ Num n âŸ§áµƒâ™® *â™® â‹… R â†’ n' âŠ‘â™® â™® n
    H {â™®âŸ¨ .n âŸ©} (âˆƒâ„˜ x ,, xâˆˆR ,, Num) = xRx

ğ’âŸ¦NumâŸ§â¸¢âŠ’â¸£ :
  âˆ€ {Î“} {n : â„¤} {R : âŸª â„˜ (â‡§ (env Î“)) âŸ«}
  â†’ âˆƒ Ï ğ‘ ğ‘¡ Ï â‹¿ R
  â†’ returnâ™® â‹… â™® n âŠ‘â™® âŸ¦ Num n âŸ§áµƒâ™® *â™® â‹… R
ğ’âŸ¦NumâŸ§â¸¢âŠ’â¸£ {Î“} {n} {R} (âˆƒ Ï ,, Ïâ‹¿R) = Ï€â‚‚ âŸ¦returnâŠ‘XâŸ§ $ âˆƒâ„˜ Ï ,, Ïâ‹¿R ,, Num

ğ’âŸ¦VarâŸ§ : âˆ€ {Î“} {x : var Î“} {Ï : âŸª â‡§ (env Î“) âŸ«} â†’ âŸ¦ Var x âŸ§áµƒâ™® â‹… Ï â‰ˆâ™® returnâ™® â‹… (lookup[ x ]â™® â‹… Ï)
ğ’âŸ¦VarâŸ§ {Î“} {x} {â™®âŸ¨ Ï âŸ©} = extâ¸¢â‰ˆâ„˜â¸£ $ LHS , RHS
  where
    LHS : âˆ€ {n} â†’ n â‹¿ âŸ¦ Var x âŸ§áµƒâ™® â‹… â™® Ï â†’ n â‹¿ returnâ™® â‹… (lookup[ x ]â™® â‹… â™® Ï)
    LHS {â™®âŸ¨ .(Ï [ x ]) âŸ©} Var = xRx
    RHS : âˆ€ {n} â†’ n â‹¿ returnâ™® â‹… (lookup[ x ]â™® â‹… â™® Ï) â†’ n â‹¿ âŸ¦ Var x âŸ§áµƒâ™® â‹… â™® Ï
    RHS â™®âŸ¨ â†¯ âŸ© = Var

ğ’âŸ¦VarâŸ§â¸¢âˆ˜â™®â¸£ : âˆ€ {Î“} {x : var Î“} â†’ âŸ¦ Var x âŸ§áµƒâ™® â‰ˆâ™® pure â‹… lookup[ x ]â™®
ğ’âŸ¦VarâŸ§â¸¢âˆ˜â™®â¸£ = extâ¸¢â‰ˆâ†—â¸£ $ Î» {Ï} â†’ ğ’âŸ¦VarâŸ§ {Ï = Ï}

ğ’âŸ¦âŠ¤â„¤âŸ§â¸¢âŠ‘â¸£ : âˆ€ {Î“} {R : âŸª â„˜ (â‡§ (env Î“)) âŸ«} â†’ âŸ¦ âŠ¤â„¤ âŸ§áµƒâ™® *â™® â‹… R âŠ‘â™® allâ™® (â‡§ â„¤)
ğ’âŸ¦âŠ¤â„¤âŸ§â¸¢âŠ‘â¸£ {Î“} {R} = extâ¸¢âŠ‘â„˜â¸£ $ Î» {n} â†’ const $ allâ™®-in {x = n}

ğ’âŸ¦UnaryâŸ§ : âˆ€ {Î“} {o : unary} {e : aexp Î“} {Ï : âŸª â‡§ (env Î“) âŸ«} â†’ âŸ¦ Unary[ o ] e âŸ§áµƒâ™® â‹… Ï â‰ˆâ™® (pure â‹… âŸ¦ o âŸ§áµƒÂ¹â™®) *â™® â‹… (âŸ¦ e âŸ§áµƒâ™® â‹… Ï)
ğ’âŸ¦UnaryâŸ§ {Î“} {o} {e} {Ï} = extâ¸¢â‰ˆâ„˜â¸£ $ LHS , RHS
  where
    LHS : âˆ€ {n} â†’ n â‹¿ âŸ¦ Unary[ o ] e âŸ§áµƒâ™® â‹… Ï â†’ n â‹¿ (pure â‹… âŸ¦ o âŸ§áµƒÂ¹â™®) *â™® â‹… (âŸ¦ e âŸ§áµƒâ™® â‹… Ï)
    LHS {â™®âŸ¨ .(âŸ¦ o âŸ§áµƒÂ¹ n) âŸ©} (Unary {n = n} ÏâŠ¢eâ‡“n) = âˆƒâ„˜ â™® n ,, ÏâŠ¢eâ‡“n ,, xRx
    RHS : âˆ€ {n} â†’ n â‹¿ (pure â‹… âŸ¦ o âŸ§áµƒÂ¹â™®) *â™® â‹… (âŸ¦ e âŸ§áµƒâ™® â‹… Ï) â†’ n â‹¿ âŸ¦ Unary[ o ] e âŸ§áµƒâ™® â‹… Ï
    RHS (âˆƒâ„˜ n' ,, ÏâŠ¢eâ‡“n' ,, â™®âŸ¨ â†¯ âŸ©) = Unary ÏâŠ¢eâ‡“n'

ğ’âŸ¦UnaryâŸ§â¸¢âŸâ¸£ : âˆ€ {Î“} {o : unary} {e : aexp Î“} â†’ âŸ¦ Unary[ o ] e âŸ§áµƒâ™® â‰ˆâ™® pure â‹… âŸ¦ o âŸ§áµƒÂ¹â™® âŸ âŸ¦ e âŸ§áµƒâ™®
ğ’âŸ¦UnaryâŸ§â¸¢âŸâ¸£ = extâ¸¢â‰ˆâ†—â¸£ $ Î» {Ï} â†’ ğ’âŸ¦UnaryâŸ§ {Ï = Ï}

ğ’âŸ¦BinaryâŸ§â¸¢*â¸£â¸¢â‹¿â¸£ :
  âˆ€ {Î“} {o : binary} {eâ‚ eâ‚‚ : aexp Î“} {R : âŸª â„˜ (â‡§ (env Î“)) âŸ«} {n : âŸª â‡§ â„¤ âŸ«}
  â†’ n â‹¿ âŸ¦ Binary[ o ] eâ‚ eâ‚‚ âŸ§áµƒâ™® *â™® â‹… R â†’ n â‹¿ (uncurryâ™® â‹… âŸ¦ o âŸ§áµƒÂ²â™®) *â™® â‹… (Î³â¸¢IAâ¸£ â‹… (âŸ¦ eâ‚ âŸ§áµƒâ™® *â™® â‹… R ,â™® âŸ¦ eâ‚‚ âŸ§áµƒâ™® *â™® â‹… R))
ğ’âŸ¦BinaryâŸ§â¸¢*â¸£â¸¢â‹¿â¸£ {n = n} (âˆƒâ„˜ Ï ,, ÏâˆˆR ,, Binary {nâ‚ = nâ‚} {nâ‚‚} {.(â™­ n)} ÏâŠ¢eâ‚â‡“nâ‚ ÏâŠ¢eâ‡“nâ‚‚ nâ‚ƒâˆˆâŸ¦oâŸ§áµ‡[nâ‚,nâ‚‚]) =
  âˆƒâ„˜ â™®âŸ¨ â™® nâ‚ , â™® nâ‚‚ âŸ© ,, (âˆƒâ„˜ Ï ,, ÏâˆˆR ,, ÏâŠ¢eâ‚â‡“nâ‚) ,  (âˆƒâ„˜ Ï ,, ÏâˆˆR ,, ÏâŠ¢eâ‡“nâ‚‚) ,, nâ‚ƒâˆˆâŸ¦oâŸ§áµ‡[nâ‚,nâ‚‚]

ğ’âŸ¦BinaryâŸ§â¸¢*â¸£â¸¢âŠ‘â¸£ :
  âˆ€ {Î“} {o : binary} {eâ‚ eâ‚‚ : aexp Î“} {R : âŸª â„˜ (â‡§ (env Î“)) âŸ«}
  â†’ âŸ¦ Binary[ o ] eâ‚ eâ‚‚ âŸ§áµƒâ™® *â™® â‹… R âŠ‘â™® (uncurryâ™® â‹… âŸ¦ o âŸ§áµƒÂ²â™®) *â™® â‹… (Î³â¸¢IAâ¸£ â‹… (âŸ¦ eâ‚ âŸ§áµƒâ™® *â™® â‹… R ,â™® âŸ¦ eâ‚‚ âŸ§áµƒâ™® *â™® â‹… R))
ğ’âŸ¦BinaryâŸ§â¸¢*â¸£â¸¢âŠ‘â¸£ = extâ¸¢âŠ‘â„˜â¸£ $ Î» {n} â†’ ğ’âŸ¦BinaryâŸ§â¸¢*â¸£â¸¢â‹¿â¸£ {n = n}
